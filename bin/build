#!/bin/sh
#
# NAME
#     build - build automation script
#
# DESCRIPTION
#
# COMMANDS
#     ws
#         Compile and execute with `g++` flags used by the Adelaide University web submission system.
#         `g++ -o main.out -O2 -Wall *.cpp`
#
#     verb
#         `g++ -O2 -pedantic -Wall -Wextra -fsanitize=address *.cpp`
#
#     gdb
#         `g++ -O2 -pedantic -Wall -Wextra -g *.cpp`
#
# AUTHOR
#     Copyright (c) Robert Zack Jaidyn Norris-Karr <rzjnzk@gmail.com> <https://github.com/rzjnzk>

set -e

_script_name="$(basename -- "${0}")"
_script_path="$(cd -- "$(dirname -- "${0}")" ; pwd)"

# Print help and exit if a help flag was supplied.
if
    test "${#}" -gt 0 \
    && test -n "$(printf "%s\n" "${@}" | sed -n "/^--help$/pq; /^-h$/pq")"
then
    sed -n \
        "
            3,/^$/
            {
                s/^# //g
                s/^#//g
                p
            }
        " \
        "${_script_path}/${_script_name}"

    exit
fi

if
    test -n "$(printf "%s\n" "${@}" | sed -n "/^ws$/p")"
then
    set -x
    g++ -o main.out -O2 -Wall *.cpp
    ./main.out
    set +x
elif
    test -n "$(printf "%s\n" "${@}" | sed -n "/^verb$/p")"
then
    set -x
    g++ -O2 -pedantic -Wall -Wextra -fsanitize=address *.cpp
    # removed -g flag (gdb) as conflicts with leak sanitiser
    ./a.out
    set +x
elif
    test -n "$(printf "%s\n" "${@}" | sed -n "/^gdb$/p")"
then
    set -x
    g++ -O2 -pedantic -Wall -Wextra -g *.cpp
    ./a.out
    set +x
fi
